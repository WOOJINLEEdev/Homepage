<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="signin.css">
    <title>WJ shopping!</title>
</head>
<body>
  <header class="header">
    <h1 class="header_title">
      <a href="postman.html" class="header_link"><span class="visually_hidden">LOGO</span></a>
    </h1>
    <div class="sign_and_cart">
      <a href="signin.html" class="signin_link"><div class="signin"><img src="user.png" class="signin_img" alt="sign in"><span class="visually_hidden">마이페이지</span></div></a>
      <a href="cart.html" class="cart_link"><div class="cart"><img src="shopping-cart.png" class="cart_img" alt="cart"><span class="visually_hidden">장바구니</span></div></a>
    </div>
  </header>

  <main class="main">
    <form class="login_form" name="login_form"  method="POST">
      <fieldset class="login_fieldset">
        <legend class="visually_hidden">로그인</legend>
        <div>
          <label for="userId" class="visually_hidden">아이디</label>
          <input type="text" name="id" id="userId" class="login_input id" placeholder="아이디" onkeydown="console.log('c')">
        </div>
        <div>
          <label for="userPassword" class="visually_hidden">비밀번호</label>
          <input type="password" name="password" id="userPassword" class="login_input password" placeholder="비밀번호">
        </div>
        <button type="button" id="logInButton" class="login_btn">로그인</button>
      </fieldset>
    </form>

    <ul class="main_find_information">
      <li class="find_info_list"><a href="#" class="find_link">아이디 찾기</a></li>
      <li class="find_info_list"><a href="#" class="find_link">비밀번호 찾기</a></li>
      <li class="find_info_list"><a href="signup.html" class="find_link">회원가입</a></li>
    </ul>
  </main>


  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="signin.js"></script>
  <script src="./jwt-decode.js"></script>
  <script>
    function goToMyPage(userId) {
        const accessToken = localStorage.getItem("access_token");
        const decoded = jwt_decode(accessToken);
        const $userId = decoded.user.id;

      fetch(`http://localhost:8282/v1/auth/join`, {
          method : "GET",
          mode: "cors",
          headers : {
              'Content-Type': 'application/json',
               Authorization : `Bearer ${accessToken}`
          }
      })
    .then((response) => response.json())
    .then(data => {
      console.log("ㅋㅋ", data);
      console.log(data);

    });

      console.log("itemId:", $userId);
      location.href = `mypage.html?user_id=${$userId}`;
    }


    window.addEventListener("DOMContentLoaded", function () {
      const [_, userId] = window.location.search.substring(1).split("=");
      console.log("페이지 테스트", userId);

      console.log("테스트 signup");
       
      let $userId = document.getElementById("userId");
      let $userPassword = document.getElementById("userPassword");
      const $signInButton = document.getElementById("logInButton");

      const userToken = localStorage.getItem("user_token");
      const userPass = localStorage.getItem("user_pass");
      const isLoggedIn = Boolean(userToken);


      $signInButton.addEventListener("click", () => {
        console.log("반응");
        // signIn();
        fetch("http://localhost:8282/v1/auth/login", {
          method : "POST",
          headers: {
            'Content-Type': 'application/json',
           },
            body : JSON.stringify({
                  user_id : $userId.value,
                  user_password : $userPassword.value
                })
        })
        .then((res) => {
          if (res.status === 200 || res.status === 201) {
            return res.json();
          }

          console.error(res.statusText);
          throw new Error("입력하신 정보와 회원 정보가 일치하지 않습니다.");
        })
        .then((accessToken) => {
          console.log(accessToken)
          const decoded = jwt_decode(accessToken);
          console.log("decoded:", decoded);
          alert("로그인되었습니다.");
          localStorage.setItem("access_token", accessToken);
          
          goToMyPage(userId);
          
        })
        .catch(err => {
          console.error(err);
          alert(err.message);
        });

      })


      function bgRed() {
          let main = document.querySelector(".main");
          main.style.backgroundColor = "rgb(255, 0, 0)";
          localStorage.setItem("bgColor","red");
      }

      function bgGreen() {
        let main = document.querySelector(".main");
        
        main.style.backgroundColor = "green";
        localStorage.setItem("bgColor","green");
      }
        

      function signIn(event) {
        const ID = $userId.value;
        const PASS = $userPassword.value;

        if("a" === ID && "1" === PASS ) {
            alert("로그인되었습니다.");
            localStorage.setItem("user_token", "jwe0f9we8f09w8e9f0809wf");
            location.href='postman.html';
            bgGreen();
          } else {
            alert("회원 정보와 일치하지 않습니다.");
            bgRed();
          }
        }

        function signOut() {
          console.log("로그아웃되었습니다.");
          localStorage.removeItem("user_tocken");
          localStorage.removeItem("user_pass");
        }


      fetch("http://localhost:8282/v1/products")
      .then((response) => response.json())
      .then(data => {
          console.log(data);
          console.log(data[0].variants[0].price);
          
      })

    })

</script>

</body>
</html>